<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Nhận diện Khuôn mặt</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .header {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card-header {
            background: linear-gradient(135deg, #a777e3, #6e8efb);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #5d7de9, #9564d2);
            transform: translateY(-2px);
        }
        .result-container {
            display: none;
            margin-top: 30px;
        }
        .face-card {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
        }
        .face-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        .face-card:hover img {
            transform: scale(1.05);
        }
        .face-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .face-card:hover .face-info {
            transform: translateY(0);
        }
        .similarity-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .loading i {
            font-size: 3rem;
            color: #6e8efb;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            font-weight: 600;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #f3f4f6, #ffffff);
            border-bottom: none;
        }
        .category-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .category-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .category-preview img:hover {
            transform: scale(1.1);
        }
        .badge-age-group {
            background-color: #28a745;
        }
        .age-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .age-group-btn {
            border-radius: 20px;
            padding: 5px 10px;
            font-size: 0.8rem;
            border: 1px solid #dee2e6;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }
        .age-group-btn:hover, .age-group-btn.active {
            background-color: #6e8efb;
            color: white;
        }
        .search-results img {
            width: 224px;
            height: 224px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .result-card {
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            text-align: center;
            width: 240px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .search-results {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .query-image {
            width: 224px;
            height: 224px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        /* Modal styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 1200px;
            border-radius: 8px;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        .modal-header {
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .search-result-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        
        .result-features {
            margin-top: 10px;
        }
        
        .similarity-score {
            font-weight: bold;
            color: #0066cc;
        }
        
        #search-results {
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            background-color: #f8f9fa;
        }
        
        .search-results-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .search-results-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        /* Main Styles */
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .card {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .feature-icon {
            font-size: 2.5rem;
            color: #0d6efd;
            margin-bottom: 15px;
        }
        
        .tab-content {
            padding-top: 20px;
        }
        
        /* Form Controls */
        .form-control:focus, .btn:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            border-color: #86b7fe;
        }
        
        /* Category Links */
        .category-link {
            text-decoration: none;
            transition: transform 0.2s;
        }
        
        .category-link:hover {
            transform: scale(1.05);
        }
        
        /* Age Group Buttons */
        .age-groups {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .age-group-btn {
            padding: 8px 16px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .age-group-btn:hover {
            background-color: #f8f9fa;
        }
        
        .age-group-btn.active {
            background-color: #0d6efd;
            color: white;
            border-color: #0d6efd;
        }
        
        /* Category Preview */
        .category-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .category-preview img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            transition: transform 0.2s;
        }
        
        .category-preview img:hover {
            transform: scale(1.1);
            cursor: pointer;
        }
        
        /* Result Container */
        .result-container {
            margin-top: 30px;
            display: none;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 1200px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
        
        /* Search Results */
        .search-results-wrapper {
            padding: 20px;
        }
        
        .query-image {
            width: 224px !important;
            height: 224px !important;
            object-fit: cover;
            border-radius: 5px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .search-results img {
            width: 224px !important;
            height: 224px !important;
            object-fit: cover;
            border-radius: 5px;
            display: block;
            margin: 0 auto;
        }
        
        .face-card {
            transition: transform 0.2s;
        }
        
        .face-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Upload Preview */
        #uploadPreview img {
            max-height: 300px;
            max-width: 100%;
            border-radius: 5px;
        }
        
        /* CSS for search results */
        #search-results {
            margin-top: 20px;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }
        
        #search-results .card-header {
            background-color: #f8f9fa;
            font-weight: 500;
        }
        
        #search-results .list-group-item {
            display: flex;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="header text-center">
        <h1><i class="fas fa-user-check"></i> Hệ thống Nhận diện và Tìm kiếm Khuôn mặt</h1>
        <p class="lead">Xây dựng, phân tích và tìm kiếm khuôn mặt dựa trên đặc trưng cảm xúc, tuổi và màu da</p>
    </div>

    <div class="container mt-5">
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab" aria-controls="search" aria-selected="true">Tìm kiếm</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab" aria-controls="database" aria-selected="false">Cơ sở dữ liệu</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab" aria-controls="categories" aria-selected="false">Phân loại</button>
            </li>
        </ul>
        
        <div class="tab-content" id="mainTabContent">
            <!-- Tab tìm kiếm -->
            <div class="tab-pane fade show active" id="search" role="tabpanel" aria-labelledby="search-tab">
                <div class="card mt-3">
                    <div class="card-body">
                        <h3>Tìm kiếm khuôn mặt tương tự</h3>
                        <p>Tải lên ảnh chứa khuôn mặt để tìm kiếm những khuôn mặt tương tự trong cơ sở dữ liệu.</p>
                        
                        <form id="searchForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="imageUpload" class="form-label">Chọn ảnh</label>
                                <input class="form-control" type="file" id="imageUpload" name="file" accept="image/*">
                            </div>
                            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                        </form>
                        
                        <div id="uploadPreview" class="mt-3 text-center d-none">
                            <h5>Ảnh đã chọn:</h5>
                            <img id="previewImage" class="img-fluid" style="max-height: 300px;">
                        </div>
                        
                        <!-- Kết quả tìm kiếm -->
                        <div id="search-results" class="mt-4"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tab cơ sở dữ liệu -->
            <div class="tab-pane fade" id="database" role="tabpanel" aria-labelledby="database-tab">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-database me-2"></i> Xây dựng Cơ sở dữ liệu
                            </div>
                            <div class="card-body">
                                <p>Xây dựng cơ sở dữ liệu đặc trưng khuôn mặt từ các ảnh hiện có. Quá trình này sẽ trích xuất thông tin về cảm xúc, tuổi và màu da từ mỗi khuôn mặt.</p>
                                <button id="buildDatabaseBtn" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-cogs me-2"></i> Xây dựng CSDL
                                </button>
                                <div id="buildStatus" class="mt-3"></div>
                            </div>
                        </div>

                        <div class="card mt-4">
                            <div class="card-header">
                                <i class="fas fa-filter me-2"></i> Lọc Khuôn mặt theo Đặc trưng
                            </div>
                            <div class="card-body">
                                <form id="filterForm">
                                    <div class="mb-3">
                                        <label for="emotion" class="form-label">Cảm xúc</label>
                                        <select id="emotion" class="form-select">
                                            <option value="">Tất cả</option>
                                            <option value="angry">Tức giận</option>
                                            <option value="disgust">Ghê tởm</option>
                                            <option value="fear">Sợ hãi</option>
                                            <option value="happy">Vui vẻ</option>
                                            <option value="sad">Buồn bã</option>
                                            <option value="surprise">Ngạc nhiên</option>
                                            <option value="neutral">Trung tính</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="skinColor" class="form-label">Màu da</label>
                                        <select id="skinColor" class="form-select">
                                            <option value="">Tất cả</option>
                                            <option value="White">Trắng</option>
                                            <option value="Yellow">Vàng</option>
                                            <option value="Black">Đen</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Nhóm tuổi</label>
                                        <div class="age-groups">
                                            <button type="button" class="age-group-btn active" data-value="">Tất cả</button>
                                            <button type="button" class="age-group-btn" data-value="child">Trẻ em</button>
                                            <button type="button" class="age-group-btn" data-value="teen">Thanh thiếu niên</button>
                                            <button type="button" class="age-group-btn" data-value="adult">Người lớn</button>
                                            <button type="button" class="age-group-btn" data-value="senior">Người cao tuổi</button>
                                        </div>
                                        <input type="hidden" id="ageGroup" name="age_group" value="">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Độ tuổi cụ thể</label>
                                        <div class="row">
                                            <div class="col">
                                                <input type="number" id="minAge" class="form-control" placeholder="Tuổi tối thiểu" min="0" max="100" value="0">
                                            </div>
                                            <div class="col">
                                                <input type="number" id="maxAge" class="form-control" placeholder="Tuổi tối đa" min="0" max="100" value="100">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-search me-2"></i> Lọc khuôn mặt
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-th me-2"></i> Thư viện ảnh theo danh mục
                            </div>
                            <div class="card-body">
                                <ul class="nav nav-tabs mb-3" id="categoryTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="emotions-tab" data-bs-toggle="tab" data-bs-target="#emotions" type="button" role="tab" aria-controls="emotions" aria-selected="true">Cảm xúc</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="age-tab" data-bs-toggle="tab" data-bs-target="#age" type="button" role="tab" aria-controls="age" aria-selected="false">Nhóm tuổi</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="skin-tab" data-bs-toggle="tab" data-bs-target="#skin" type="button" role="tab" aria-controls="skin" aria-selected="false">Màu da</button>
                                    </li>
                                </ul>
                                <div class="tab-content" id="categoryTabsContent">
                                    <div class="tab-pane fade show active" id="emotions" role="tabpanel">
                                        <p>Hình ảnh phân loại theo cảm xúc:</p>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <a href="#" class="category-link badge bg-primary" data-category="happy" data-type="emotions">Vui vẻ</a>
                                            <a href="#" class="category-link badge bg-danger" data-category="angry" data-type="emotions">Tức giận</a>
                                            <a href="#" class="category-link badge bg-warning text-dark" data-category="surprise" data-type="emotions">Ngạc nhiên</a>
                                            <a href="#" class="category-link badge bg-secondary" data-category="neutral" data-type="emotions">Trung tính</a>
                                            <a href="#" class="category-link badge bg-info text-dark" data-category="fear" data-type="emotions">Sợ hãi</a>
                                            <a href="#" class="category-link badge bg-dark" data-category="disgust" data-type="emotions">Ghê tởm</a>
                                            <a href="#" class="category-link badge bg-secondary" data-category="sad" data-type="emotions">Buồn bã</a>
                                        </div>
                                        <div id="emotionCategoryPreview" class="category-preview">
                                            <!-- Preview images will be loaded here -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="age" role="tabpanel">
                                        <p>Hình ảnh phân loại theo nhóm tuổi:</p>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <a href="#" class="category-link badge bg-success" data-category="child" data-type="age">Trẻ em</a>
                                            <a href="#" class="category-link badge bg-info text-dark" data-category="teen" data-type="age">Thanh thiếu niên</a>
                                            <a href="#" class="category-link badge bg-primary" data-category="adult" data-type="age">Người lớn</a>
                                            <a href="#" class="category-link badge bg-secondary" data-category="senior" data-type="age">Người cao tuổi</a>
                                        </div>
                                        <div id="ageCategoryPreview" class="category-preview">
                                            <!-- Preview images will be loaded here -->
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="skin" role="tabpanel">
                                        <p>Hình ảnh phân loại theo màu da:</p>
                                        <div class="d-flex flex-wrap gap-2 mb-2">
                                            <a href="#" class="category-link badge bg-light text-dark" data-category="White" data-type="skin">Trắng</a>
                                            <a href="#" class="category-link badge bg-warning text-dark" data-category="Yellow" data-type="skin">Vàng</a>
                                            <a href="#" class="category-link badge bg-dark" data-category="Black" data-type="skin">Đen</a>
                                        </div>
                                        <div id="skinCategoryPreview" class="category-preview">
                                            <!-- Preview images will be loaded here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="filterResultsContainer" class="mt-4 d-none">
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-list-ul me-2"></i> Kết quả Lọc
                        </div>
                        <div class="card-body">
                            <div class="row" id="filteredFaces"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tab phân loại -->
            <div class="tab-pane fade" id="categories" role="tabpanel" aria-labelledby="categories-tab">
                <div class="card mt-3">
                    <div class="card-body">
                        <h3>Danh mục khuôn mặt</h3>
                        <p>Xem tất cả khuôn mặt theo các danh mục khác nhau.</p>
                        
                        <!-- Category content will be loaded here -->
                        <div id="categoriesContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3 text-center text-muted">
        <div class="container">
            <p>Hệ thống Nhận diện và Tìm kiếm Khuôn mặt &copy; 2023</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to close modal
        function closeModal() {
            document.getElementById('categoryModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('categoryModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
        
        // Translation functions
        function translateEmotion(emotion) {
            const translations = {
                'happy': 'Vui vẻ',
                'sad': 'Buồn',
                'angry': 'Giận dữ',
                'fear': 'Sợ hãi',
                'disgust': 'Ghê tởm',
                'surprise': 'Ngạc nhiên',
                'neutral': 'Trung tính'
            };
            return translations[emotion] || emotion;
        }
        
        function translateAgeGroup(ageGroup) {
            const translations = {
                'child': 'Trẻ em',
                'teen': 'Thanh thiếu niên',
                'adult': 'Người lớn',
                'senior': 'Người cao tuổi'
            };
            return translations[ageGroup] || ageGroup;
        }
        
        function translateSkinColor(skinColor) {
            const translations = {
                'White': 'Trắng',
                'Yellow': 'Vàng',
                'Black': 'Đen',
                'unknown': 'Không xác định'
            };
            return translations[skinColor] || skinColor;
        }
        
        function translateCategory(category, type) {
            if (type === 'emotions') {
                return translateEmotion(category);
            } else if (type === 'age') {
                return translateAgeGroup(category);
            } else if (type === 'skin') {
                return translateSkinColor(category);
            }
            return category;
        }
        
        // Document ready event handler
        document.addEventListener('DOMContentLoaded', function() {
            // Image preview functionality
            const imageUpload = document.getElementById('imageUpload');
            const previewImage = document.getElementById('previewImage');
            const uploadPreview = document.getElementById('uploadPreview');
            
            imageUpload.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        uploadPreview.classList.remove('d-none');
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            // Handle search form submission
            const searchForm = document.getElementById('searchForm');
            
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                const searchResults = document.getElementById('search-results');
                
                // Show loading indicator
                searchResults.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>Đang tìm kiếm...</p></div>';
                
                // Send request to server
                fetch('/search', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Pass the data to display function
                    displaySearchResults(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    searchResults.innerHTML = '<div class="alert alert-danger">Đã xảy ra lỗi khi tìm kiếm. Vui lòng thử lại sau.</div>';
                });
            });
            
            // Handle buildDatabase button click
            const buildDatabaseBtn = document.getElementById('buildDatabaseBtn');
            const buildStatus = document.getElementById('buildStatus');
            
            buildDatabaseBtn.addEventListener('click', function() {
                // Disable button and show processing state
                buildDatabaseBtn.disabled = true;
                buildDatabaseBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xây dựng...';
                buildStatus.innerHTML = '<div class="alert alert-info">Đang xây dựng cơ sở dữ liệu, vui lòng đợi...</div>';
                
                // Send request to server
                fetch('/build-database', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        buildStatus.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
                    } else {
                        buildStatus.innerHTML = `<div class="alert alert-danger">${data.message || 'Có lỗi xảy ra'}</div>`;
                    }
                    
                    // Re-enable button
                    buildDatabaseBtn.disabled = false;
                    buildDatabaseBtn.innerHTML = '<i class="fas fa-cogs me-2"></i> Xây dựng CSDL';
                })
                .catch(error => {
                    console.error('Error:', error);
                    buildStatus.innerHTML = '<div class="alert alert-danger">Đã xảy ra lỗi khi xây dựng cơ sở dữ liệu. Vui lòng thử lại sau.</div>';
                    
                    // Re-enable button
                    buildDatabaseBtn.disabled = false;
                    buildDatabaseBtn.innerHTML = '<i class="fas fa-cogs me-2"></i> Xây dựng CSDL';
                });
            });
            
            // Handle filter form submission
            const filterForm = document.getElementById('filterForm');
            const filteredFaces = document.getElementById('filteredFaces');
            const filterResultsContainer = document.getElementById('filterResultsContainer');
            
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                // Show loading
                filteredFaces.innerHTML = '<div class="col-12 text-center"><div class="spinner-border" role="status"></div><p>Đang lọc dữ liệu...</p></div>';
                filterResultsContainer.classList.remove('d-none');
                
                // Build query parameters
                const emotion = document.getElementById('emotion').value;
                const skinColor = document.getElementById('skinColor').value;
                const ageGroup = document.getElementById('ageGroup').value;
                const minAge = document.getElementById('minAge').value;
                const maxAge = document.getElementById('maxAge').value;
                
                // Send request to server
                fetch('/filter', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.results.length > 0) {
                        let html = '';
                        
                        data.results.forEach(result => {
                            html += `
                                <div class="col-md-4 col-sm-6 mb-4">
                                    <div class="card h-100">
                                        <img src="/${result.image_path}" class="card-img-top" alt="Face" style="height: 200px; object-fit: cover;">
                                        <div class="card-body">
                                            <p class="mb-1">Cảm xúc: ${translateEmotion(result.emotion)}</p>
                                            <p class="mb-1">Tuổi: ${result.age} (${translateAgeGroup(result.age_group)})</p>
                                            <p class="mb-0">Màu da: ${translateSkinColor(result.skin_color)}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        filteredFaces.innerHTML = html;
                    } else {
                        filteredFaces.innerHTML = '<div class="col-12"><div class="alert alert-info">Không tìm thấy kết quả phù hợp.</div></div>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    filteredFaces.innerHTML = '<div class="col-12"><div class="alert alert-danger">Đã xảy ra lỗi khi lọc dữ liệu. Vui lòng thử lại sau.</div></div>';
                });
            });
            
            // Handle category links click
            const categoryLinks = document.querySelectorAll('.category-link');
            
            categoryLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const category = this.getAttribute('data-category');
                    const type = this.getAttribute('data-type') || 'emotions';
                    
                    // Open modal with category images
                    loadCategoryImages(type, category);
                });
            });
            
            // Age group buttons
            const ageGroupBtns = document.querySelectorAll('.age-group-btn');
            const ageGroupInput = document.getElementById('ageGroup');
            
            ageGroupBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    ageGroupBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Set hidden input value
                    ageGroupInput.value = this.getAttribute('data-value');
                });
            });
            
            // Load initial category previews
            loadCategoryPreviews();
        });
        
        // Function to display search results
        function displaySearchResults(data) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            
            if (!data || !data.query_image || !data.results) {
                resultsContainer.innerHTML = '<p>Không tìm thấy kết quả</p>';
                return;
            }
            
            // Create container for results
            const resultsWrapper = document.createElement('div');
            resultsWrapper.className = 'search-results-wrapper';
            
            // Create heading
            const heading = document.createElement('h4');
            heading.textContent = 'Kết quả tìm kiếm';
            heading.className = 'mb-4';
            resultsWrapper.appendChild(heading);
            
            // Create query image row
            const queryRow = document.createElement('div');
            queryRow.className = 'row mb-4';
            
            // Query image column
            const queryImageCol = document.createElement('div');
            queryImageCol.className = 'col-md-3';
            
            // Create query image
            const queryImage = document.createElement('img');
            queryImage.src = 'data:image/jpeg;base64,' + data.query_image;
            queryImage.alt = 'Ảnh tìm kiếm';
            queryImage.className = 'query-image img-fluid';
            queryImage.style.width = '224px';
            queryImage.style.height = '224px';
            queryImage.style.objectFit = 'cover';
            
            queryImageCol.appendChild(queryImage);
            
            // Query features column
            const queryFeaturesCol = document.createElement('div');
            queryFeaturesCol.className = 'col-md-9';
            
            // Create features card
            const featuresCard = document.createElement('div');
            featuresCard.className = 'card';
            
            // Card header
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            cardHeader.textContent = 'Đặc trưng khuôn mặt tìm kiếm';
            
            // Card body
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            // Features table
            const featuresTable = document.createElement('table');
            featuresTable.className = 'table';
            
            // Table body
            const tableBody = document.createElement('tbody');
            
            // Add feature rows
            if (data.query_features) {
                const features = data.query_features;
                
                // Age row
                const ageRow = document.createElement('tr');
                const ageLabelCell = document.createElement('th');
                ageLabelCell.textContent = 'Tuổi:';
                const ageValueCell = document.createElement('td');
                ageValueCell.textContent = features.age || 'Không xác định';
                ageRow.appendChild(ageLabelCell);
                ageRow.appendChild(ageValueCell);
                tableBody.appendChild(ageRow);
                
                // Age group row
                const ageGroupRow = document.createElement('tr');
                const ageGroupLabelCell = document.createElement('th');
                ageGroupLabelCell.textContent = 'Nhóm tuổi:';
                const ageGroupValueCell = document.createElement('td');
                ageGroupValueCell.textContent = translateAgeGroup(features.age_group) || 'Không xác định';
                ageGroupRow.appendChild(ageGroupLabelCell);
                ageGroupRow.appendChild(ageGroupValueCell);
                tableBody.appendChild(ageGroupRow);
                
                // Gender row
                const genderRow = document.createElement('tr');
                const genderLabelCell = document.createElement('th');
                genderLabelCell.textContent = 'Giới tính:';
                const genderValueCell = document.createElement('td');
                genderValueCell.textContent = features.gender || 'Không xác định';
                genderRow.appendChild(genderLabelCell);
                genderRow.appendChild(genderValueCell);
                tableBody.appendChild(genderRow);
                
                // Emotion row
                const emotionRow = document.createElement('tr');
                const emotionLabelCell = document.createElement('th');
                emotionLabelCell.textContent = 'Cảm xúc:';
                const emotionValueCell = document.createElement('td');
                emotionValueCell.textContent = translateEmotion(features.emotion) || 'Không xác định';
                emotionRow.appendChild(emotionLabelCell);
                emotionRow.appendChild(emotionValueCell);
                tableBody.appendChild(emotionRow);
                
                // Skin color row
                const skinColorRow = document.createElement('tr');
                const skinColorLabelCell = document.createElement('th');
                skinColorLabelCell.textContent = 'Màu da:';
                const skinColorValueCell = document.createElement('td');
                skinColorValueCell.textContent = translateSkinColor(features.skin_color) || 'Không xác định';
                skinColorRow.appendChild(skinColorLabelCell);
                skinColorRow.appendChild(skinColorValueCell);
                tableBody.appendChild(skinColorRow);
            }
            
            // Add table to card
            featuresTable.appendChild(tableBody);
            cardBody.appendChild(featuresTable);
            featuresCard.appendChild(cardHeader);
            featuresCard.appendChild(cardBody);
            queryFeaturesCol.appendChild(featuresCard);
            
            // Add columns to row
            queryRow.appendChild(queryImageCol);
            queryRow.appendChild(queryFeaturesCol);
            
            // Add query row to results
            resultsWrapper.appendChild(queryRow);
            
            // Create similar images heading
            const similarHeading = document.createElement('h5');
            similarHeading.textContent = 'Khuôn mặt tương tự';
            similarHeading.className = 'mt-4 mb-3';
            resultsWrapper.appendChild(similarHeading);
            
            // Create similar images row
            const similarRow = document.createElement('div');
            similarRow.className = 'row';
            
            // Add similar faces
            data.results.forEach((result, index) => {
                // Create column for each similar face
                const similarCol = document.createElement('div');
                similarCol.className = 'col-md-4 mb-4';
                
                // Create card
                const similarCard = document.createElement('div');
                similarCard.className = 'card h-100';
                
                // Card header with similarity score
                const similarHeader = document.createElement('div');
                similarHeader.className = 'card-header d-flex justify-content-between align-items-center';
                
                const matchLabel = document.createElement('span');
                matchLabel.textContent = `Kết quả #${index + 1}`;
                
                const similarityBadge = document.createElement('span');
                similarityBadge.className = 'badge bg-primary';
                similarityBadge.textContent = `${(result.similarity * 100).toFixed(2)}%`;
                
                similarHeader.appendChild(matchLabel);
                similarHeader.appendChild(similarityBadge);
                
                // Card body
                const similarBody = document.createElement('div');
                similarBody.className = 'card-body text-center';
                
                // Similar face image
                const similarImage = document.createElement('img');
                similarImage.src = 'data:image/jpeg;base64,' + result.image;
                similarImage.alt = `Khuôn mặt tương tự #${index + 1}`;
                similarImage.className = 'img-fluid mb-3';
                similarImage.style.width = '224px';
                similarImage.style.height = '224px';
                similarImage.style.objectFit = 'cover';
                
                similarBody.appendChild(similarImage);
                
                // Features list
                const featuresList = document.createElement('ul');
                featuresList.className = 'list-group list-group-flush';
                
                // Age item
                const ageItem = document.createElement('li');
                ageItem.className = 'list-group-item';
                ageItem.textContent = `Tuổi: ${result.features.age || 'Không xác định'}`;
                featuresList.appendChild(ageItem);
                
                // Age group item
                const ageGroupItem = document.createElement('li');
                ageGroupItem.className = 'list-group-item';
                ageGroupItem.textContent = `Nhóm tuổi: ${translateAgeGroup(result.features.age_group) || 'Không xác định'}`;
                featuresList.appendChild(ageGroupItem);
                
                // Emotion item
                const emotionItem = document.createElement('li');
                emotionItem.className = 'list-group-item';
                emotionItem.textContent = `Cảm xúc: ${translateEmotion(result.features.emotion) || 'Không xác định'}`;
                featuresList.appendChild(emotionItem);
                
                // Skin color item
                const skinColorItem = document.createElement('li');
                skinColorItem.className = 'list-group-item';
                skinColorItem.textContent = `Màu da: ${translateSkinColor(result.features.skin_color) || 'Không xác định'}`;
                featuresList.appendChild(skinColorItem);
                
                // Add components to card
                similarCard.appendChild(similarHeader);
                similarCard.appendChild(similarBody);
                similarCard.appendChild(featuresList);
                
                // Add card to column
                similarCol.appendChild(similarCard);
                
                // Add column to row
                similarRow.appendChild(similarCol);
            });
            
            // Add similar row to results
            resultsWrapper.appendChild(similarRow);
            
            // Add all results to container
            resultsContainer.appendChild(resultsWrapper);
        }
        
        // Function to load category images
        function loadCategoryImages(type, category) {
            // Show modal
            const categoryModal = document.getElementById('categoryModal');
            const categoryModalTitle = document.getElementById('categoryModalTitle');
            const categoryModalContent = document.getElementById('categoryModalContent');
            
            categoryModalTitle.textContent = translateCategory(category, type);
            categoryModalContent.innerHTML = '<div class="text-center"><div class="spinner-border"></div><p>Đang tải...</p></div>';
            categoryModal.style.display = 'block';
            
            // Fetch category images
            fetch(`/api/category/${type}/${category}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        let html = '<div class="row">';
                        
                        data.images.forEach(image => {
                            html += `
                                <div class="col-md-3 mb-3">
                                    <div class="card">
                                        <img src="/${image.image_path}" class="card-img-top" alt="Face" style="height: 200px; object-fit: cover;">
                                        <div class="card-body small">
                                            <p class="mb-1">Cảm xúc: ${translateEmotion(image.emotion)}</p>
                                            <p class="mb-1">Tuổi: ${image.age} (${translateAgeGroup(image.age_group)})</p>
                                            <p class="mb-0">Màu da: ${translateSkinColor(image.skin_color)}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div>';
                        categoryModalContent.innerHTML = html;
                    } else {
                        categoryModalContent.innerHTML = `<div class="alert alert-warning">Không thể tải ảnh cho danh mục này: ${data.message || 'Lỗi không xác định'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error loading category images:', error);
                    categoryModalContent.innerHTML = '<div class="alert alert-danger">Đã xảy ra lỗi khi tải ảnh danh mục. Vui lòng thử lại sau.</div>';
                });
        }
        
        // Function to load category previews
        function loadCategoryPreviews() {
            // Load emotion preview
            fetch('/api/category/emotions/happy')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const previewContainer = document.getElementById('emotionCategoryPreview');
                        previewContainer.innerHTML = '';
                        
                        // Display up to 8 preview images
                        data.images.slice(0, 8).forEach(image => {
                            const img = document.createElement('img');
                            img.src = `/${image.image_path}`;
                            img.alt = 'Happy face';
                            previewContainer.appendChild(img);
                        });
                    }
                })
                .catch(error => console.error('Error loading emotion previews:', error));
            
            // Load age group preview
            fetch('/api/category/age/adult')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const previewContainer = document.getElementById('ageCategoryPreview');
                        previewContainer.innerHTML = '';
                        
                        // Display up to 8 preview images
                        data.images.slice(0, 8).forEach(image => {
                            const img = document.createElement('img');
                            img.src = `/${image.image_path}`;
                            img.alt = 'Adult face';
                            previewContainer.appendChild(img);
                        });
                    }
                })
                .catch(error => console.error('Error loading age previews:', error));
            
            // Load skin color preview
            fetch('/api/category/skin/White')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const previewContainer = document.getElementById('skinCategoryPreview');
                        previewContainer.innerHTML = '';
                        
                        // Display up to 8 preview images
                        data.images.slice(0, 8).forEach(image => {
                            const img = document.createElement('img');
                            img.src = `/${image.image_path}`;
                            img.alt = 'White skin face';
                            previewContainer.appendChild(img);
                        });
                    }
                })
                .catch(error => console.error('Error loading skin previews:', error));
        }
    </script>
</body>
</html> 